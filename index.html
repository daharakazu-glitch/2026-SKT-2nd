<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2024年度 第3回 全統記述模試 英語 重要語句復習アプリ（2年SKT添削第2回）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', '"Noto Sans JP"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.7);
        }
        @media (min-width: 640px) {
            .card { padding: 32px; }
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: #0ea5e9; color: white; }
        .btn-primary:hover { background: #0284c7; }
        .btn-secondary { background: white; color: #475569; border: 1px solid #e2e8f0; }
        .btn-green { background: #10b981; color: white; }
        .btn-red { background: #ef4444; color: white; }
        .btn-orange { background: #f97316; color: white; }
        .btn-disabled { background: #cbd5e1; color: #94a3b8; cursor: not-allowed; }
        
        .hidden { display: none !important; }
        
        .quiz-option {
            border: 2px solid #f1f5f9;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        .quiz-option:hover { border-color: #0ea5e9; background-color: #f0f9ff; }
        .quiz-option.correct { border-color: #10b981; background-color: #d1fae5; color: #065f46; }
        .quiz-option.incorrect { border-color: #ef4444; background-color: #fee2e2; color: #991b1b; }
        
        #mic-icon.recording { animation: pulse 1.5s infinite; color: white; }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .word-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            color: #0ea5e9;
            border-radius: 0.25rem;
            border-color: #cbd5e1;
        }
        
        #word-list::-webkit-scrollbar { width: 6px; }
        #word-list::-webkit-scrollbar-track { background: transparent; }
        #word-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-8">
        <header class="text-center mb-10">
            <div class="inline-block p-2 bg-white rounded-2xl shadow-sm mb-4">
                <span class="px-3 py-1 bg-brand-100 text-brand-600 rounded-lg text-xs font-bold tracking-wider uppercase">Zentou Mock Exam Review</span>
            </div>
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-extrabold text-slate-900 tracking-tight leading-tight">
                <span class="text-brand-600">2024年度 第3回 全統記述模試</span><br>
                英語 重要語句復習アプリ（2年SKT添削第2回）
            </h1>
        </header>

        <!-- Setup Section -->
        <section id="setup-section" class="card space-y-8 animate-fade-in">
            <div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center">
                        <span class="flex items-center justify-center w-8 h-8 rounded-full bg-brand-100 text-brand-600 text-sm mr-3">1</span>
                        語句を選択
                    </h2>
                    <div class="flex space-x-2">
                        <button id="select-all" class="text-xs font-medium text-brand-600 hover:text-brand-700 hover:bg-brand-50 px-3 py-1.5 rounded-lg transition">すべて選択</button>
                        <button id="deselect-all" class="text-xs font-medium text-slate-500 hover:text-slate-700 hover:bg-slate-100 px-3 py-1.5 rounded-lg transition">すべて解除</button>
                    </div>
                </div>
                
                <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
                    <div id="word-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 max-h-[60vh] overflow-y-auto pr-2">
                        <div class="col-span-full text-center text-slate-400 py-8">語彙をロード中...</div>
                    </div>
                </div>
            </div>

            <div>
                <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center">
                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-brand-100 text-brand-600 text-sm mr-3">2</span>
                    学習モード
                </h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <label class="relative flex items-center p-4 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition-all group bg-white">
                        <input type="radio" name="mode" value="word" class="peer sr-only" checked>
                        <div class="w-5 h-5 border-2 border-slate-300 rounded-full mr-3 peer-checked:border-brand-500 peer-checked:bg-brand-500"></div>
                        <div class="flex flex-col">
                            <span class="font-bold text-slate-700">単語・フレーズ</span>
                            <span class="text-xs text-slate-500">抽出された重要語句をそのまま学習</span>
                        </div>
                    </label>
                    <label class="relative flex items-center p-4 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition-all group bg-white">
                        <input type="radio" name="mode" value="sentence" class="peer sr-only">
                        <div class="w-5 h-5 border-2 border-slate-300 rounded-full mr-3 peer-checked:border-brand-500 peer-checked:bg-brand-500"></div>
                        <div class="flex flex-col">
                            <span class="font-bold text-slate-700">例文で学習</span>
                            <span class="text-xs text-slate-500">実戦的な例文を追加して学習</span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="pt-4 flex flex-col sm:flex-row gap-4 justify-center items-center border-t border-slate-100">
                <button id="start-learning-btn" class="btn btn-primary w-full sm:w-auto text-lg min-w-[200px]">
                    <i class="fas fa-play mr-2 text-sm"></i> 学習を開始
                </button>
                <button id="quick-test-btn" class="btn btn-orange w-full sm:w-auto text-lg">
                    <i class="fas fa-random mr-2"></i> ランダムテスト
                </button>
                <button id="download-pdf-btn" class="btn btn-green w-full sm:w-auto text-lg">
                    <i class="fas fa-file-pdf mr-2 text-white"></i> PDF作成
                </button>
            </div>
        </section>

        <!-- Learning Section -->
        <section id="learning-section" class="card hidden flex flex-col h-auto min-h-[600px]">
            <div class="flex justify-between items-center mb-6">
                 <button id="back-to-setup-btn" class="text-sm text-slate-500 hover:text-slate-800 flex items-center transition">
                    <i class="fas fa-arrow-left mr-2"></i> 戻る
                </button>
                <div class="bg-slate-100 px-4 py-1.5 rounded-full">
                    <span id="progress-indicator" class="text-sm font-bold text-slate-600 font-mono"></span>
                </div>
                <div class="w-16"></div>
            </div>
            
            <div class="flex-grow flex flex-col justify-center mb-8 text-center">
                <div id="flashcard-container" class="relative w-full cursor-pointer group">
                    <div class="relative w-full min-h-[350px] bg-white rounded-2xl border-2 border-slate-100 shadow-sm hover:border-brand-200 transition-all duration-300 flex flex-col items-center justify-center p-6">
                        <div class="w-full flex flex-col items-center">
                            <div id="illustration-area" class="hidden mb-6 text-brand-500">
                                <i class="fas fa-brain text-5xl opacity-80"></i>
                            </div>
                            <p id="english-text" class="text-3xl sm:text-4xl font-bold text-slate-800 mb-6 leading-tight select-text"></p>
                            <div id="japanese-wrapper" class="h-auto min-h-[4rem] transition-all duration-300 opacity-0 transform translate-y-4">
                                <p id="japanese-text" class="text-xl sm:text-2xl text-brand-600 font-medium"></p>
                            </div>
                            <p class="text-xs text-slate-400 mt-8 uppercase tracking-widest">Click to reveal</p>
                        </div>
                    </div>
                </div>
                <div id="pronunciation-feedback-container" class="mt-6 min-h-[60px]"></div>
            </div>

            <div class="mt-auto">
                <div class="flex justify-center items-center space-x-6 mb-8">
                    <button id="speak-btn" class="btn btn-secondary rounded-full w-14 h-14 p-0 flex items-center justify-center shadow-sm">
                        <i class="fas fa-volume-up text-xl"></i>
                    </button>
                    <button id="record-btn" class="btn btn-red rounded-full w-16 h-16 p-0 flex items-center justify-center shadow-lg">
                        <i id="mic-icon" class="fas fa-microphone text-2xl"></i>
                    </button>
                    <button id="play-recording-btn" class="btn btn-green btn-disabled rounded-full w-14 h-14 p-0 flex items-center justify-center shadow-sm" disabled title="自分の声を聞く">
                        <i class="fas fa-play text-xl"></i>
                    </button>
                </div>
                <audio id="recording-player" class="hidden"></audio>

                <div class="flex justify-between items-center gap-2">
                    <button id="prev-btn" class="btn btn-secondary px-4 sm:px-6"><i class="fas fa-chevron-left mr-2"></i> 前へ</button>
                    <button id="start-test-btn" class="btn btn-primary flex-grow sm:flex-grow-0 px-8 shadow-md">テストへ</button>
                    <button id="next-btn" class="btn btn-secondary px-4 sm:px-6">次へ <i class="fas fa-chevron-right ml-2"></i></button>
                </div>
            </div>
        </section>

        <!-- Test Options Section -->
        <section id="test-options-section" class="card hidden text-center py-16">
            <h2 class="text-3xl font-bold text-slate-800 mb-8">テスト問題数</h2>
            <div id="test-choices" class="flex flex-wrap justify-center gap-4 mb-12"></div>
            <button id="back-to-learning-btn" class="text-slate-500 hover:text-slate-800 font-medium">戻る</button>
        </section>

        <!-- Quiz Section -->
        <section id="quiz-section" class="card hidden">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                 <h2 class="text-xl font-bold">テスト中 <span id="quiz-progress" class="text-sm bg-brand-100 text-brand-700 px-2 py-1 rounded"></span></h2>
                 <button id="abort-test-btn" class="text-sm text-red-500">中断</button>
            </div>
            <div class="mb-8 text-center">
                <p id="quiz-question" class="text-3xl sm:text-4xl font-bold text-slate-800 mb-8"></p>
                <div id="quiz-options" class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-left"></div>
            </div>
            <div id="feedback" class="text-center font-bold my-4 min-h-[40px] text-lg"></div>
            <div class="text-center h-14">
                 <button id="next-question-btn" class="hidden btn btn-primary px-8">次へ</button>
            </div>
        </section>

        <!-- Results Section -->
        <section id="results-section" class="card hidden text-center py-12">
            <div class="mb-6"><span class="text-5xl font-bold text-brand-600" id="score-percentage"></span></div>
            <p id="score-text" class="text-xl text-slate-600 mb-8"></p>
            <div id="incorrect-answers-container" class="text-left bg-red-50 border border-red-100 rounded-xl p-6 mb-8 hidden">
                <h3 class="text-lg font-bold text-red-800 mb-4">復習リスト</h3>
                <ul id="incorrect-answers-list" class="space-y-2"></ul>
            </div>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="restart-btn" class="btn btn-primary">もう一度</button>
                <button id="back-to-home-btn" class="btn btn-secondary">ホーム</button>
            </div>
        </section>
    </div>

    <!-- PDF Modal -->
    <div id="pdf-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg overflow-hidden shadow-2xl">
            <div class="bg-slate-50 px-6 py-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold">PDF作成メニュー</h3>
                <button id="close-modal-icon" class="text-slate-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 grid grid-cols-1 gap-3">
                <button id="download-list-btn" class="p-3 border rounded-lg hover:bg-brand-50 text-left font-bold text-slate-700">1. 重要語句・意味リスト</button>
                <button id="download-en-quiz-btn" class="p-3 border rounded-lg hover:bg-brand-50 text-left font-bold text-slate-700">2. 英単語テスト</button>
                <button id="download-ja-quiz-btn" class="p-3 border rounded-lg hover:bg-brand-50 text-left font-bold text-slate-700">3. 和訳テスト</button>
                <button id="download-mixed-quiz-btn" class="p-3 border rounded-lg hover:bg-brand-50 text-left font-bold text-slate-700">4. 混合実戦テスト</button>
                <button id="download-sentence-quiz-btn" class="p-3 border rounded-lg hover:bg-brand-50 text-left font-bold text-slate-700">5. 例文穴埋めテスト</button>
                <button id="download-sentence-mixed-quiz-btn" class="p-3 border rounded-lg hover:bg-brand-50 text-left font-bold text-slate-700">6. 長文記述・和訳テスト</button>
            </div>
            <div class="bg-slate-50 px-6 py-3 border-t text-right">
                <button id="close-modal-btn" class="text-sm font-medium text-slate-500">閉じる</button>
            </div>
        </div>
    </div>

    <script>
        const APP_TITLE = "2024年度 第3回 全統記述模試 英語 重要語句復習アプリ（2年SKT添削第2回）";

        // --- VOCABULARY DATA EXTRACTED FROM PDF ---
        const vocabularyData = [
            {"english": "get on A", "japanese": "A(自転車など)に乗る", "sentence": "I'll get on my bicycle and ride to the station.", "sentence_ja": "自転車に乗って駅まで行きます。"},
            {"english": "get in A", "japanese": "A(車など)に乗る", "sentence": "He had to get in the car to go to the countryside.", "sentence_ja": "彼は田舎へ行くために車に乗らなければなりませんでした。"},
            {"english": "put O on/put on O", "japanese": "Oを身につける [着る]", "sentence": "You should put on your bathing suit and dive into the pool.", "sentence_ja": "水着を着てプールに飛び込むべきです。"},
            {"english": "memory", "japanese": "記憶力", "sentence": "The scientists tested the rats' memory by having them swim.", "sentence_ja": "科学者たちはラットを泳がせることで記憶力をテストしました。"},
            {"english": "swim through A", "japanese": "Aを(端から端まで)泳ぐ", "sentence": "Rats were trained to swim through a complex course.", "sentence_ja": "ラットは複雑なコースを泳ぐよう訓練されました。"},
            {"english": "complex", "japanese": "複雑な", "sentence": "This puzzle is quite complex and difficult to solve.", "sentence_ja": "このパズルはかなり複雑で解くのが難しいです。"},
            {"english": "unlike A", "japanese": "Aと違って/Aと異なり", "sentence": "Swimming, unlike walking, involves all major muscle groups.", "sentence_ja": "水泳は、ウォーキングと違って、すべての主要な筋肉群を使います。"},
            {"english": "activity", "japanese": "活動/運動", "sentence": "These activities are all good for brain health.", "sentence_ja": "これらの運動はすべて脳の健康に良いです。"},
            {"english": "A like B", "japanese": "(たとえば)BのようなA", "sentence": "Rhythmic exercise like cycling helps keep the heart healthy.", "sentence_ja": "サイクリングのようなリズミカルな運動は、心臓の健康維持に役立ちます。"},
            {"english": "involve O", "japanese": "Oを(必然的に)含む/Oを関与させる", "sentence": "The project will involve many local residents.", "sentence_ja": "そのプロジェクトには多くの地域住民が関わることになります。"},
            {"english": "major", "japanese": "主要な", "sentence": "It is important to engage the body's major muscle groups.", "sentence_ja": "体の主要な筋肉群を動かすことが重要です。"},
            {"english": "muscle group", "japanese": "筋肉群", "sentence": "Swimming exercises every major muscle group in the body.", "sentence_ja": "水泳は体の中のあらゆる主要な筋肉群を鍛えます。"},
            {"english": "therefore", "sentence": "Swimming involves all muscles; therefore, it requires the heart to work hard.", "japanese": "その結果", "sentence_ja": "水泳はすべての筋肉を使うため、その結果、心臓を激しく働かせます。"},
            {"english": "extra", "japanese": "普段以上に", "sentence": "Intense exercise requires the heart to work extra hard.", "sentence_ja": "激しい運動は心臓を普段以上に懸命に働かせます。"},
            {"english": "perhaps", "japanese": "ことによると/かもしれない", "sentence": "This discovery perhaps explains the connection between exercise and brain health.", "sentence_ja": "この発見は、ことによると運動と脳の健康の関係を説明するかもしれません。"},
            {"english": "brain", "japanese": "脳", "sentence": "Exercise provides significant benefits for the brain.", "sentence_ja": "運動は脳に大きな恩恵をもたらします。"},
            {"english": "benefit", "japanese": "利益/恩恵", "sentence": "One major benefit of swimming is improved mental health.", "sentence_ja": "水泳の大きな恩恵の一つは、精神的健康の向上です。"},
            {"english": "be good at doing", "japanese": "･･･するのが得意である", "sentence": "John is not very good at swimming yet.", "sentence_ja": "ジョンはまだ水泳があまり得意ではありません。"},
            {"english": "decide to do", "japanese": "･･･することに決める [する]", "sentence": "I've decided to go to a swimming class every weekend.", "sentence_ja": "毎週末、水泳教室に通うことに決めました。"},
            {"english": "swimming class", "japanese": "水泳教室", "sentence": "Joining a swimming class is a great way to stay fit.", "sentence_ja": "水泳教室に入るのは、健康を保つための素晴らしい方法です。"},
            {"english": "as for A", "japanese": "Aについて言えば", "sentence": "As for me, I'll recommend my grandfather to swim.", "sentence_ja": "私について言えば、祖父に泳ぐよう勧めるつもりです。"},
            {"english": "recommend O to do", "japanese": "Oに･･･するよう勧める", "sentence": "Doctors recommend us to exercise regularly.", "sentence_ja": "医者は私たちに定期的に運動するよう勧めています。"},
            {"english": "these days", "japanese": "近頃", "sentence": "He often forgets something these days.", "sentence_ja": "彼は近頃よく物忘れをします。"},
            {"english": "make OC", "japanese": "OをCにする", "sentence": "His forgetfulness makes his mother worried.", "sentence_ja": "彼の物忘れはお母さんを心配させます。"},
            {"english": "worried", "japanese": "心配して", "sentence": "I am worried about my grandfather's health.", "sentence_ja": "私は祖父の健康を心配しています。"},
            {"english": "call out, \"...\"", "japanese": "大声を出して「･･･」と言う", "sentence": "He called out, \"Please bring me a newspaper.\"", "sentence_ja": "彼は「新聞を持ってきてくれ」と大声で言いました。"},
            {"english": "ask O wh-節", "japanese": "･･･か尋ねる [訊く]", "sentence": "He asked me what day it was today.", "sentence_ja": "彼は私に今日は何曜日か尋ねました。"},
            {"english": "X rather than Y", "japanese": "YではなくX/YよりもむしろX", "sentence": "We should take him to a hospital rather than just recommending exercise.", "sentence_ja": "ただ運動を勧めるのではなく、彼を病院に連れて行くべきです。"},
            {"english": "improve O", "japanese": "○を改善する", "sentence": "Swimming can improve the ability to remember things.", "sentence_ja": "水泳は物事を記憶する能力を改善することができます。"},
            {"english": "ability to do", "japanese": "･･･する能力", "sentence": "Exercise enhances our ability to learn effectively.", "sentence_ja": "運動は効果的に学習する能力を高めます。"},
            {"english": "mood", "japanese": "気分", "sentence": "Regular activity can reduce bad moods and anxiety.", "sentence_ja": "定期的な活動は、悪い気分や不安を軽減できます。"},
            {"english": "rhythmic", "japanese": "リズミカルな", "sentence": "Rhythmic exercise helps keep the heart healthy.", "sentence_ja": "リズミカルな運動は心臓を健康に保つのに役立ちます。"},
            {"english": "engage O", "japanese": "○を従事させる [動かす]", "sentence": "It is good to engage the body's large muscle groups.", "sentence_ja": "体の大きな筋肉群を動かすのは良いことです。"},
            {"english": "help (to) do", "japanese": "･･･するのに役立つ", "sentence": "This research helps us understand the brain better.", "sentence_ja": "この研究は、私たちが脳をより良く理解するのに役立ちます。"},
            {"english": "keep OC", "japanese": "OをCのままにしておく", "sentence": "Exercise helps keep us mentally sharp.", "sentence_ja": "運動は私たちを知的に鋭い状態に保つのに役立ちます。"},
            {"english": "recent", "japanese": "最近の", "sentence": "Recent research suggests that not all exercises work equally.", "sentence_ja": "最近の研究は、すべての運動が同じように機能するわけではないことを示唆しています。"},
            {"english": "research", "japanese": "研究", "sentence": "Scientific research into the brain has progressed rapidly.", "sentence_ja": "脳に関する科学的研究は急速に進歩しました。"},
            {"english": "suggest (that) SV...", "japanese": "･･･ということを示唆する", "sentence": "The data suggest that swimming has unique benefits.", "sentence_ja": "そのデータは、水泳には独特の恩恵があることを示唆しています。"},
            {"english": "work", "japanese": "機能する", "sentence": "Different types of exercise work in different ways.", "sentence_ja": "異なる種類の運動は、異なる方法で機能します。"},
            {"english": "equally", "japanese": "等しく/ 同様に", "sentence": "All these activities are good, but they don't work equally.", "sentence_ja": "これらの活動はすべて良いですが、同じように機能するわけではありません。"},
            {"english": "advantage", "japanese": "有利/利益", "sentence": "For the biggest brain advantage, you should try swimming.", "sentence_ja": "脳にとって最大の利益を得るためには、水泳を試すべきです。"},
            {"english": "bathing suit", "japanese": "水着", "sentence": "Don't forget to pack your bathing suit for the beach.", "sentence_ja": "海に行くのに水着を詰めるのを忘れないでください。"},
            {"english": "dive into A", "japanese": "Aに飛び込む", "sentence": "He was brave enough to dive into the cold water.", "sentence_ja": "彼は冷たい水の中に飛び込むほど勇敢でした。"},
            {"english": "train O to do", "japanese": "Oを･･･するよう訓練する", "sentence": "Scientists trained adult rats to swim every day.", "sentence_ja": "科学者たちは成体ラットに毎日泳ぐよう訓練しました。"},
            {"english": "adult", "japanese": "大人の/成体の", "sentence": "Adult rats were used in this memory experiment.", "sentence_ja": "この記憶実験には成体ラットが使われました。"},
            {"english": "by doing", "japanese": "･･･することによって [で]", "sentence": "You can improve your English by reading many books.", "sentence_ja": "たくさんの本を読むことによって、英語を向上させることができます。"},
            {"english": "have O do", "japanese": "Oに･･･させる", "sentence": "The teacher had the students read the article aloud.", "sentence_ja": "先生は生徒たちにその記事を音読させました。"},
            {"english": "location", "japanese": "位置", "sentence": "Rats improved their ability to remember the location of a platform.", "sentence_ja": "ラットは台の位置を記憶する能力を向上させました。"},
            {"english": "hide O", "japanese": "○を隠す", "sentence": "They tried to hide the present from their mother.", "sentence_ja": "彼らは母親からプレゼントを隠そうとしました。"},
            {"english": "platform", "japanese": "プラットホーム/壇/台", "sentence": "The rat swam towards the hidden platform in the water.", "sentence_ja": "ラットは水中の隠された台に向かって泳ぎました。"},
            {"english": "look at A", "japanese": "Aを見る [調べる]", "sentence": "Researchers looked at the effects of exercise on young rats.", "sentence_ja": "研究者たちは、若いラットに対する運動の効果を調べました。"},
            {"english": "researcher", "japanese": "研究者", "sentence": "Researchers found that swimming improved mood.", "sentence_ja": "研究者たちは水泳が気分を改善することを発見しました。"},
            {"english": "reduce O", "japanese": "○を軽減する", "sentence": "Deep breathing can help reduce stress and anxiety.", "sentence_ja": "深呼吸はストレスや不安を軽減するのに役立ちます。"},
            {"english": "structure", "japanese": "構造", "sentence": "The body structure of rats is similar to humans.", "sentence_ja": "ラットの体の構造は人間に似ています。"},
            {"english": "be like A", "japanese": "Aに似ている", "sentence": "The new building is like a giant ship.", "sentence_ja": "その新しい建物は巨大な船のようです。"},
            {"english": "surprisingly", "japanese": "驚くほど", "sentence": "The results were surprisingly good for such a short study.", "sentence_ja": "そのような短い研究にしては、結果は驚くほど良かったです。"},
            {"english": "similar", "japanese": "似た/同様の", "sentence": "The two brothers have very similar voices.", "sentence_ja": "その二人の兄弟はとても似た声をしています。"},
            {"english": "result", "japanese": "結果", "sentence": "They found similar results when testing human subjects.", "sentence_ja": "人間の被験者をテストした際にも、同様の結果が得られました。"},
            {"english": "put O to the test", "japanese": "○を試す [テストする]", "sentence": "They put the new theory to the test in the laboratory.", "sentence_ja": "彼らは実験室で新しい理論をテストしました。"},
            {"english": "include O", "japanese": "○を含む/ を参加させる [対象とする]", "sentence": "One study included eighteen teenagers as participants.", "sentence_ja": "ある研究では、18人のティーンエイジャーを参加者として含みました。"},
            {"english": "trained", "japanese": "トレーニングを受けた", "sentence": "Eight of the teenagers were trained swimmers.", "sentence_ja": "ティーンエイジャーのうち8人はトレーニングを受けた水泳選手でした。"},
            {"english": "regularly", "japanese": "定期的に", "sentence": "She exercises regularly to maintain her health.", "sentence_ja": "彼女は健康維持のために定期的に運動しています。"},
            {"english": "on land", "japanese": "陸上で", "sentence": "Some animals are fast in the water but slow on land.", "sentence_ja": "水中では速いが陸上では遅い動物もいます。"},
            {"english": "do well", "japanese": "よい結果を出す", "sentence": "Both groups did well on the mental tasks.", "sentence_ja": "両方のグループが知的な課題で良い結果を出しました。"},
            {"english": "measure O", "japanese": "○を測定する", "sentence": "The test measures your ability to complete tasks quickly.", "sentence_ja": "そのテストは、課題を素早くこなす能力を測定します。"},
            {"english": "complete O", "japanese": "○を完成させる/Oをこなす", "sentence": "I need more time to complete this assignment.", "sentence_ja": "この課題を完成させるにはもっと時間が必要です。"},
            {"english": "mental", "japanese": "精神的な/頭を使う/頭脳の", "sentence": "Solving puzzles provides excellent mental stimulation.", "sentence_ja": "パズルを解くことは、素晴らしい頭の刺激になります。"},
            {"english": "task", "japanese": "課題", "sentence": "We were given a difficult task to solve in teams.", "sentence_ja": "私たちはチームで解決すべき難しい課題を与えられました。"},
            {"english": "the elderly", "japanese": "高齢の人々", "sentence": "Swimming is also beneficial for the elderly.", "sentence_ja": "水泳は高齢の人々にとっても有益です。"},
            {"english": "connection", "japanese": "関係/結合", "sentence": "There is a strong connection between physical and mental health.", "sentence_ja": "身体的健康と精神的健康には強い関係があります。"},
            {"english": "function", "japanese": "機能", "sentence": "Scientists are studying how brain function changes with age.", "sentence_ja": "科学者たちは、加齢に伴い脳機能がどのように変化するかを研究しています。"},
            {"english": "not quite", "japanese": "必ずしも [完全に]･･･というわけではない", "sentence": "I'm not quite sure if this is the right answer.", "sentence_ja": "これが正解かどうか、完全には確信が持てません。"},
            {"english": "the 1960s", "japanese": "1960年代", "sentence": "Brain research has changed a lot since the 1960s.", "sentence_ja": "脳の研究は1960年代から大きく変わりました。"},
            {"english": "a limited number of A", "japanese": "限られた数のA", "sentence": "There are only a limited number of tickets available.", "sentence_ja": "利用可能なチケットは限られた数しかありません。"},
            {"english": "once S V...", "japanese": "(いったん)･･･と", "sentence": "Once you start, it becomes much easier.", "sentence_ja": "いったん始めれば、ずっと楽になります。"},
            {"english": "start doing", "japanese": "･･･し始める", "sentence": "He started doing yoga to improve his flexibility.", "sentence_ja": "彼は柔軟性を高めるためにヨガをし始めました。"},
            {"english": "die off", "japanese": "(いなくなるまで)次々に死ぬ", "sentence": "Scientists used to think brain cells simply die off.", "sentence_ja": "科学者たちはかつて、脳細胞はただ次々に死ぬだけだと思っていました。"},
            {"english": "with age", "japanese": "加齢 [年齢]とともに", "sentence": "Memory doesn't have to decline significantly with age.", "sentence_ja": "記憶力は加齢とともに大幅に低下する必要はありません。"},
            {"english": "be gone", "japanese": "なくなる", "sentence": "After the fire, all the old documents were gone.", "sentence_ja": "火事の後、すべての古い書類がなくなってしまいました。"},
            {"english": "for good", "japanese": "永久に", "sentence": "They left the city for good and moved to the country.", "sentence_ja": "彼らはその街を永久に去り、田舎へ引っ越しました。"},
            {"english": "repair", "japanese": "修理/修復", "sentence": "Exercise can contribute to the repair of damaged brain cells.", "sentence_ja": "運動は、損傷した脳細胞の修復に寄与することができます。"},
            {"english": "damaged", "japanese": "損傷した", "sentence": "The damaged cells can sometimes be repaired by the body.", "sentence_ja": "損傷した細胞は、時として体によって修復されることがあります。"},
            {"english": "formation", "japanese": "形成", "sentence": "Vigorous activity helps in the formation of new connections.", "sentence_ja": "活発な活動は新しい結合の形成を助けます。"},
            {"english": "A called C", "japanese": "Cと呼ばれるA", "sentence": "A substance called BDNF is essential for brain growth.", "sentence_ja": "BDNFと呼ばれる物質は、脳の成長に不可欠です。"},
            {"english": "in response to A", "japanese": "Aに反応して", "sentence": "The heart rate increases in response to exercise.", "sentence_ja": "心拍数は運動に反応して増加します。"},
            {"english": "growth", "japanese": "増加/成長", "sentence": "There was a rapid growth in the number of participants.", "sentence_ja": "参加者の数に急速な増加がありました。"},
            {"english": "blood flow", "japanese": "血流", "sentence": "Good blood flow is necessary for a healthy brain.", "sentence_ja": "健康な脳には良好な血流が必要です。"},
            {"english": "lead to A", "japanese": "Aに至る/Aをもたらす", "sentence": "Increased activity leads to the creation of new vessels.", "sentence_ja": "活動の増加は、新しい血管の創造をもたらします。"},
            {"english": "creation", "japanese": "創造", "sentence": "This process supports the creation of new brain cells.", "sentence_ja": "このプロセスは、新しい脳細胞の創造を支えます。"},
            {"english": "mean O", "japanese": "○を意味する / ○ということである", "sentence": "More blood vessels mean increased blood flow to the brain.", "sentence_ja": "より多くの血管は、脳への血流増加を意味します。"},
            {"english": "increased A", "japanese": "増えた [上昇した] A / Aの増加 [上昇]", "sentence": "The study showed increased levels of BDNF after swimming.", "sentence_ja": "その研究は、水泳の後にBDNFレベルが上昇したことを示しました。"},
            {"english": "deliver O", "japanese": "○を配達する [供給する]", "sentence": "More blood delivers more nutrients to the brain.", "sentence_ja": "より多くの血液が脳により多くの栄養を供給します。"},
            {"english": "support O", "japanese": "○を支える", "sentence": "Healthy habits support brain function for a long time.", "sentence_ja": "健康的な習慣は、長い間脳機能を支えます。"},
            {"english": "effectively", "japanese": "効果的に", "sentence": "We can learn more effectively if we exercise regularly.", "sentence_ja": "定期的に運動すれば、より効果的に学習できます。"},
            {"english": "affect O", "japanese": "○に影響を与える", "sentence": "Stress can affect our memory negatively.", "sentence_ja": "ストレスは私たちの記憶に悪い影響を与える可能性があります。"},
            {"english": "positively", "japanese": "肯定的に/よい方向に", "sentence": "BDNF affects mental function positively.", "sentence_ja": "BDNFは精神機能に良い方向に影響を与えます。"},
            {"english": "anxiety", "japanese": "不安", "sentence": "Exercise is known to reduce levels of anxiety.", "sentence_ja": "運動は不安のレベルを下げることが知られています。"},
            {"english": "depression", "japanese": "憂鬱", "sentence": "Swimming can help fight against mild depression.", "sentence_ja": "水泳は軽い憂鬱と戦うのに役立ちます。"},
            {"english": "discovery", "japanese": "発見", "sentence": "This discovery changed how we think about aging.", "sentence_ja": "この発見は、私たちの老化に対する考え方を変えました。"},
            {"english": "generate O", "japanese": "○を生み出す [生成する]", "sentence": "New brain cells can be generated even in adults.", "sentence_ja": "大人であっても新しい脳細胞は生成され得ます。"},
            {"english": "the way S V...", "japanese": "･･･する方法/･･･の仕方", "sentence": "Technology has changed the way we live today.", "sentence_ja": "テクノロジーは今日の私たちの生き方を変えました。"},
            {"english": "grow C", "japanese": "Cになる", "sentence": "We should stay active even as we grow older.", "sentence_ja": "年をとっても、活動的であり続けるべきです。"},
            {"english": "age", "japanese": "年をとる / 年齢を重ねる", "sentence": "As we age, it is important to keep our minds active.", "sentence_ja": "年をとるにつれ、心を活動的に保つことが重要です。"},
            {"english": "simple", "japanese": "単純な/簡単な", "sentence": "It is a simple question, but hard to answer.", "sentence_ja": "それは単純な質問ですが、答えるのが難しいです。"},
            {"english": "pleasant", "japanese": "楽しい", "sentence": "A pleasant dip in the lake can be very refreshing.", "sentence_ja": "湖での楽しいひと泳ぎは、とてもリフレッシュさせてくれます。"},
            {"english": "mentally", "japanese": "精神的に/知的に", "sentence": "Reading books helps keep you mentally sharp.", "sentence_ja": "本を読むことは、あなたを知的に鋭い状態に保つのに役立ちます。"},
            {"english": "sharp", "japanese": "鋭い/頭の切れる", "sentence": "He remained mentally sharp until his 90s.", "sentence_ja": "彼は90代まで知的に鋭いままでした。"},
            {"english": "for the rest of one's life", "japanese": "･･･の残りの人生の間", "sentence": "I want to live in this town for the rest of my life.", "sentence_ja": "私は残りの人生の間、この町で暮らしたいです。"}
        ];

        // --- APP STATE ---
        let selectedWords = [];
        let currentWordIndex = 0;
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let incorrectAnswers = [];
        let voices = [];
        let recognition;
        let mediaRecorder;
        let audioChunks = [];
        let recordedAudioURL = null;

        const els = {
            setupSection: document.getElementById('setup-section'),
            learningSection: document.getElementById('learning-section'),
            testOptionsSection: document.getElementById('test-options-section'),
            quizSection: document.getElementById('quiz-section'),
            resultsSection: document.getElementById('results-section'),
            wordList: document.getElementById('word-list'),
            flashcardContainer: document.getElementById('flashcard-container'),
            englishText: document.getElementById('english-text'),
            japaneseWrapper: document.getElementById('japanese-wrapper'),
            japaneseText: document.getElementById('japanese-text'),
            progressIndicator: document.getElementById('progress-indicator'),
            illustrationArea: document.getElementById('illustration-area'),
            pronunciationFeedback: document.getElementById('pronunciation-feedback-container'),
            micIcon: document.getElementById('mic-icon'),
            recordingPlayer: document.getElementById('recording-player')
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            renderWordList();
            initSpeech();
            attachListeners();
            switchSection('setup');
        });

        function renderWordList() {
            els.wordList.innerHTML = '';
            vocabularyData.forEach((word, index) => {
                const div = document.createElement('div');
                div.className = 'relative flex items-start p-3 bg-white border border-slate-200 rounded-lg hover:border-brand-300 transition-colors cursor-pointer group';
                div.innerHTML = `
                    <div class="flex items-center h-5">
                        <input type="checkbox" class="word-checkbox" data-index="${index}" checked>
                    </div>
                    <div class="ml-3 text-sm">
                        <label class="font-bold text-slate-800 block cursor-pointer group-hover:text-brand-600">${word.english}</label>
                        <p class="text-slate-500 text-xs mt-1 cursor-pointer">${word.japanese}</p>
                    </div>
                `;
                div.onclick = (e) => {
                    if (e.target.type !== 'checkbox') {
                        const cb = div.querySelector('input');
                        cb.checked = !cb.checked;
                    }
                };
                els.wordList.appendChild(div);
            });
        }

        function switchSection(name) {
            ['setupSection', 'learningSection', 'testOptionsSection', 'quizSection', 'resultsSection'].forEach(k => {
                if(els[k]) {
                    els[k].classList.add('hidden');
                    els[k].classList.remove('animate-fade-in');
                }
            });
            const target = els[name + 'Section'];
            if(target) {
                target.classList.remove('hidden');
                requestAnimationFrame(() => target.classList.add('animate-fade-in'));
            }
        }

        function updateCard() {
            const word = selectedWords[currentWordIndex];
            const mode = document.querySelector('input[name="mode"]:checked').value;
            
            els.japaneseWrapper.classList.remove('opacity-100', 'translate-y-0');
            els.japaneseWrapper.classList.add('opacity-0', 'translate-y-4');
            els.pronunciationFeedback.innerHTML = '';

            if (mode === 'sentence' && word.sentence) {
                els.illustrationArea.classList.remove('hidden');
                const base = word.english.split('/')[0].split(' ')[0].replace(/[^\w]/g, '');
                const regex = new RegExp(`(${base}\\w*)`, 'gi');
                els.englishText.innerHTML = word.sentence.replace(regex, '<span class="text-brand-600 border-b-2 border-brand-200">$1</span>');
                els.japaneseText.innerHTML = word.sentence_ja || word.japanese;
                els.englishText.className = "text-2xl sm:text-3xl font-bold text-slate-800 mb-6 leading-tight select-text";
            } else {
                els.illustrationArea.classList.add('hidden');
                els.englishText.textContent = word.english;
                els.japaneseText.textContent = word.japanese;
                els.englishText.className = "text-3xl sm:text-4xl font-bold text-slate-800 mb-6 leading-tight select-text";
            }

            els.progressIndicator.textContent = `${currentWordIndex + 1} / ${selectedWords.length}`;
            
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            prevBtn.disabled = currentWordIndex === 0;
            nextBtn.disabled = currentWordIndex === selectedWords.length - 1;
            prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
            nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
        }

        function generateQuiz(count) {
            if (!selectedWords.length) return;
            const pool = [...selectedWords].sort(() => 0.5 - Math.random()).slice(0, count);
            quizQuestions = pool.map(w => {
                const correct = w.japanese;
                const distractors = vocabularyData
                    .filter(x => x.japanese !== correct)
                    .sort(() => 0.5 - Math.random())
                    .slice(0, 3)
                    .map(x => x.japanese);
                return {
                    q: w.english,
                    correct,
                    opts: [correct, ...distractors].sort(() => 0.5 - Math.random())
                };
            });
            score = 0;
            currentQuestionIndex = 0;
            incorrectAnswers = [];
            showQuizQuestion();
            switchSection('quiz');
        }

        function showQuizQuestion() {
            const q = quizQuestions[currentQuestionIndex];
            if(!q) return;
            document.getElementById('quiz-question').textContent = q.q;
            document.getElementById('quiz-progress').textContent = `${currentQuestionIndex + 1}/${quizQuestions.length}`;
            const optsEl = document.getElementById('quiz-options');
            optsEl.innerHTML = '';
            document.getElementById('feedback').innerHTML = '';
            document.getElementById('next-question-btn').classList.add('hidden');

            q.opts.forEach(opt => {
                const btn = document.createElement('div');
                btn.className = 'quiz-option text-lg font-medium';
                btn.textContent = opt;
                btn.onclick = () => handleAnswer(btn, opt, q);
                optsEl.appendChild(btn);
            });
        }

        function handleAnswer(btn, ans, q) {
            if (document.querySelector('.quiz-option.correct')) return;
            const isCorrect = ans === q.correct;
            if (isCorrect) {
                btn.classList.add('correct');
                document.getElementById('feedback').innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle"></i> 正解!</span>';
                score++;
            } else {
                btn.classList.add('incorrect');
                [...document.querySelectorAll('.quiz-option')].forEach(el => {
                    if (el.textContent === q.correct) el.classList.add('correct');
                });
                document.getElementById('feedback').innerHTML = `<span class="text-red-500"><i class="fas fa-times-circle"></i> 正解: ${q.correct}</span>`;
                incorrectAnswers.push({q: q.q, a: q.correct});
            }
            document.getElementById('next-question-btn').classList.remove('hidden');
        }

        function initSpeech() {
            if ('speechSynthesis' in window) {
                const loadVoices = () => {
                    voices = window.speechSynthesis.getVoices();
                };
                window.speechSynthesis.onvoiceschanged = loadVoices;
                loadVoices();
            }
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        }

        function speakText(text) {
            const clean = text.replace(/<[^>]*>/g, '').split('/')[0].replace(/[^\w\s]/g, '').trim();
            const u = new SpeechSynthesisUtterance(clean);
            u.lang = 'en-US';
            u.rate = 0.85;
            const v = voices.find(x => x.name.includes('Google US English')) || 
                      voices.find(x => x.name.includes('Samantha')) || 
                      voices.find(x => x.lang === 'en-US');
            if (v) u.voice = v;
            window.speechSynthesis.speak(u);
        }

        const getLevenshteinDist = (s, t) => {
            const m = s.length, n = t.length;
            const d = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));
            for (let i = 0; i <= m; i++) d[i][0] = i;
            for (let j = 0; j <= n; j++) d[0][j] = j;
            for (let j = 1; j <= n; j++) {
                for (let i = 1; i <= m; i++) {
                    const cost = s[i - 1] === t[j - 1] ? 0 : 1;
                    d[i][j] = Math.min(d[i - 1][j] + 1, d[i][j - 1] + 1, d[i - 1][j - 1] + cost);
                }
            }
            return d[m][n];
        };

        function attachListeners() {
            document.getElementById('select-all').onclick = () => document.querySelectorAll('.word-checkbox').forEach(c => c.checked = true);
            document.getElementById('deselect-all').onclick = () => document.querySelectorAll('.word-checkbox').forEach(c => c.checked = false);
            
            document.getElementById('start-learning-btn').onclick = () => {
                const checks = document.querySelectorAll('.word-checkbox:checked');
                if (!checks.length) return alert('単語を選択してください');
                selectedWords = Array.from(checks).map(c => vocabularyData[c.dataset.index]);
                currentWordIndex = 0;
                updateCard();
                switchSection('learning');
            };

            document.getElementById('quick-test-btn').onclick = () => {
                const checks = document.querySelectorAll('.word-checkbox:checked');
                if (!checks.length) return alert('単語を選択してください');
                selectedWords = Array.from(checks).map(c => vocabularyData[c.dataset.index]);
                const div = document.getElementById('test-choices');
                div.innerHTML = '';
                [10, 20, 50, selectedWords.length].filter((v, i, a) => a.indexOf(v) === i && v <= selectedWords.length).forEach(n => {
                    const b = document.createElement('button');
                    b.className = 'btn btn-primary w-24 h-24 flex flex-col items-center justify-center text-xl shadow-lg';
                    b.innerHTML = `<span class="font-bold text-3xl">${n}</span><span class="text-xs">問</span>`;
                    b.onclick = () => generateQuiz(n);
                    div.appendChild(b);
                });
                switchSection('testOptions');
            };

            els.flashcardContainer.onclick = () => {
                els.japaneseWrapper.classList.toggle('opacity-0');
                els.japaneseWrapper.classList.toggle('opacity-100');
                els.japaneseWrapper.classList.toggle('translate-y-4');
                els.japaneseWrapper.classList.toggle('translate-y-0');
            };

            document.getElementById('prev-btn').onclick = () => { if (currentWordIndex > 0) { currentWordIndex--; updateCard(); } };
            document.getElementById('next-btn').onclick = () => { if (currentWordIndex < selectedWords.length - 1) { currentWordIndex++; updateCard(); } };
            document.getElementById('speak-btn').onclick = (e) => { e.stopPropagation(); speakText(els.englishText.textContent); };
            
            document.getElementById('start-test-btn').onclick = () => {
                generateQuiz(Math.min(10, selectedWords.length));
            };

            document.getElementById('record-btn').onclick = async (e) => {
                e.stopPropagation();
                if (!window.SpeechRecognition) return alert('音声認識非対応のブラウザです。');
                if (recognition && recognition.started) { recognition.stop(); return; }

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = ev => audioChunks.push(ev.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(audioChunks, { type: 'audio/wav' });
                        recordedAudioURL = URL.createObjectURL(blob);
                        els.recordingPlayer.src = recordedAudioURL;
                        document.getElementById('play-recording-btn').disabled = false;
                        document.getElementById('play-recording-btn').classList.remove('btn-disabled');
                        els.micIcon.classList.remove('recording');
                        els.micIcon.className = 'fas fa-microphone text-2xl';
                        stream.getTracks().forEach(t => t.stop());
                    };
                    mediaRecorder.start();

                    recognition = new SpeechRecognition();
                    recognition.lang = 'en-US';
                    recognition.started = true;
                    els.micIcon.className = 'fas fa-stop text-2xl';
                    els.micIcon.classList.add('recording');
                    els.pronunciationFeedback.innerHTML = '<span class="text-brand-500 animate-pulse">Listening...</span>';

                    recognition.onresult = (ev) => {
                        const transcript = ev.results[0][0].transcript.toLowerCase().trim();
                        const target = els.englishText.textContent.toLowerCase().replace(/<[^>]*>/g, '').split('/')[0].replace(/[^\w\s]/g, '').trim();
                        
                        const d = getLevenshteinDist(transcript, target);
                        const maxLen = Math.max(transcript.length, target.length);
                        const scoreVal = Math.max(0, Math.round((1 - d / (maxLen || 1)) * 100));
                        
                        let msg = '', color = '';
                        if (scoreVal > 65) { msg = 'Excellent!'; color = 'text-green-600'; }
                        else if (scoreVal > 35) { msg = 'Good job!'; color = 'text-blue-500'; }
                        else { msg = 'Try again'; color = 'text-red-500'; }
                        
                        els.pronunciationFeedback.innerHTML = `
                            <div class="flex flex-col items-center">
                                <span class="text-xs text-slate-400">You said: "${transcript}"</span>
                                <span class="text-xl font-bold ${color}">${msg} (${scoreVal}%)</span>
                            </div>
                        `;
                    };
                    recognition.onend = () => {
                        recognition.started = false;
                        if (mediaRecorder.state === 'recording') mediaRecorder.stop();
                    };
                    recognition.start();
                } catch (err) { alert('マイクの使用を許可してください'); }
            };

            document.getElementById('play-recording-btn').onclick = (e) => { e.stopPropagation(); els.recordingPlayer.play(); };
            document.getElementById('back-to-setup-btn').onclick = () => switchSection('setup');
            document.getElementById('back-to-home-btn').onclick = () => switchSection('setup');
            document.getElementById('abort-test-btn').onclick = () => switchSection('setup');
            document.getElementById('restart-btn').onclick = () => switchSection('setup');
            document.getElementById('back-to-learning-btn').onclick = () => switchSection('setup');

            document.getElementById('next-question-btn').onclick = () => {
                currentQuestionIndex++;
                if (currentQuestionIndex < quizQuestions.length) showQuizQuestion();
                else {
                    document.getElementById('score-percentage').textContent = Math.round(score/quizQuestions.length*100)+'%';
                    document.getElementById('score-text').textContent = `${score} / ${quizQuestions.length} 正解`;
                    const list = document.getElementById('incorrect-answers-list');
                    list.innerHTML = '';
                    incorrectAnswers.forEach(it => {
                        const li = document.createElement('li');
                        li.className = "bg-white p-3 rounded border text-sm";
                        li.innerHTML = `<div class="font-bold">${it.q}</div><div class="text-red-500">正解: ${it.a}</div>`;
                        list.appendChild(li);
                    });
                    document.getElementById('incorrect-answers-container').classList.toggle('hidden', incorrectAnswers.length === 0);
                    switchSection('results');
                }
            };

            document.getElementById('download-pdf-btn').onclick = () => document.getElementById('pdf-modal').classList.remove('hidden');
            document.getElementById('close-modal-icon').onclick = () => document.getElementById('pdf-modal').classList.add('hidden');
            document.getElementById('close-modal-btn').onclick = () => document.getElementById('pdf-modal').classList.add('hidden');
        }

        const pdfActions = [
            { id: 'download-list-btn', title: '重要語句・意味リスト', content: (ws) => `<table style="width:100%; border-collapse:collapse;">${ws.map((w, i) => `<tr><td style="border:1px solid #ddd; padding:8px; width:40px;">${i+1}</td><td style="border:1px solid #ddd; padding:8px; font-weight:bold;">${w.english}</td><td style="border:1px solid #ddd; padding:8px;">${w.japanese}</td></tr>`).join('')}</table>` },
            { id: 'download-en-quiz-btn', title: '英単語テスト', content: (ws) => `<h2>問題</h2><ol>${ws.map((w) => `<li style="margin-bottom:15px;">${w.japanese} → ____________________</li>`).join('')}</ol><h2 style="page-break-before:always;">解答</h2><ol>${ws.map(w => `<li>${w.english}</li>`).join('')}</ol>` },
            { id: 'download-ja-quiz-btn', title: '和訳テスト', content: (ws) => `<h2>問題</h2><ol>${ws.map((w) => `<li style="margin-bottom:15px;">${w.english} → ____________________</li>`).join('')}</ol><h2 style="page-break-before:always;">解答</h2><ol>${ws.map(w => `<li>${w.japanese}</li>`).join('')}</ol>` },
            { id: 'download-mixed-quiz-btn', title: '混合実戦テスト', content: (ws) => {
                const shuf = [...ws].sort(()=>0.5-Math.random());
                const qs = shuf.map(w => Math.random()>0.5 ? `${w.japanese} → ________________` : `${w.english} → ________________`);
                const as = shuf.map((w,i) => qs[i].includes(w.japanese) ? w.english : w.japanese);
                return `<h2>問題</h2><ol>${qs.map(q=>`<li style="margin-bottom:15px;">${q}</li>`).join('')}</ol><h2 style="page-break-before:always;">解答</h2><ol>${as.map(a=>`<li>${a}</li>`).join('')}</ol>`;
            }},
            { id: 'download-sentence-quiz-btn', title: '例文穴埋めテスト', content: (ws) => {
                const valid = ws.filter(w => w.sentence);
                return `<h2>問題</h2><ol>${valid.map(w => {
                    const base = w.english.split('/')[0].split(' ')[0].replace(/[^\w]/g, '');
                    return `<li style="margin-bottom:15px;">${w.sentence.replace(new RegExp(base+'\\w*','i'), '__________')}<br><small>(${w.sentence_ja})</small></li>`;
                }).join('')}</ol><h2 style="page-break-before:always;">解答</h2><ol>${valid.map(w=>`<li>${w.english}</li>`).join('')}</ol>`;
            }},
            { id: 'download-sentence-mixed-quiz-btn', title: '長文記述・和訳テスト', content: (ws) => {
                const valid = ws.filter(w => w.sentence).sort(()=>0.5-Math.random());
                const qs = [], as = [];
                valid.forEach(w => {
                    const base = w.english.split('/')[0].split(' ')[0].replace(/[^\w]/g, '');
                    if(Math.random()>0.5) {
                        qs.push(`${w.sentence.replace(new RegExp(base+'\\w*','i'), '__________')}<br><small>(${w.sentence_ja})</small>`);
                        as.push(w.english);
                    } else {
                        const m = w.sentence.match(new RegExp(base+'\\w*','i'));
                        qs.push(`<u>${m ? m[0] : w.english}</u> を和訳しなさい。<br><small>${w.sentence}</small>`);
                        as.push(w.japanese);
                    }
                });
                return `<h2>問題</h2><ol>${qs.map(q=>`<li style="margin-bottom:15px;">${q}</li>`).join('')}</ol><h2 style="page-break-before:always;">解答</h2><ol>${as.map(a=>`<li>${a}</li>`).join('')}</ol>`;
            }}
        ];

        window.onload = () => {
            pdfActions.forEach(act => {
                const btn = document.getElementById(act.id);
                if(btn) {
                    btn.onclick = () => {
                        const checks = document.querySelectorAll('.word-checkbox:checked');
                        if (!checks.length) return alert('単語を選択してください');
                        const words = Array.from(checks).map(c => vocabularyData[c.dataset.index]);
                        const w = window.open('', '_blank');
                        w.document.write(`<html>
                            <head>
                                <title>${act.title}</title>
                                <style>
                                    body{font-family:sans-serif;margin:40px;line-height:1.6;}
                                    .app-title{text-align:center;font-size:14px;color:#666;margin-bottom:5px;}
                                    h1{text-align:center;border-bottom:2px solid #333;padding-bottom:10px;margin-top:0;}
                                    h2{background:#f4f4f4;padding:5px 10px;margin-top:30px;}
                                    ol li{margin-bottom:12px;}
                                </style>
                            </head>
                            <body>
                                <div class="app-title">${APP_TITLE}</div>
                                <h1>${act.title}</h1>
                                ${act.content(words)}
                            </body>
                        </html>`);
                        w.document.close();
                        setTimeout(() => w.print(), 500);
                    };
                }
            });
        };
    </script>
</body>
</html>